document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("pasteArea"),t=document.getElementById("filenameInput"),n=document.getElementById("saveButton"),o=document.getElementById("fileType"),r=document.getElementById("searchInput"),c=document.getElementById("feedback"),l=document.getElementById("tree"),i=document.getElementById("helpButton"),s=document.getElementById("pinButton"),a=document.getElementById("instructions");if(!l)return void console.error("Tree div not found!");const d=(navigator.language||navigator.userLanguage).startsWith("zh");function m(e=""){l.innerHTML="",chrome.storage.local.get(["markdownFiles"],(t=>{const n=t.markdownFiles||{};let o=0;Object.values(n).flat().forEach((e=>{e.savedAt&&e.savedAt>o&&(o=e.savedAt)}));const r=Object.keys(n).sort(((e,t)=>t.localeCompare(e)));for(const t of r){const r=n[t]||[],c=r.filter((t=>(t.title?.toLowerCase()||"").includes(e)||(t.filename?.toLowerCase()||"").includes(e)));if(0===c.length)continue;const i=document.createElement("div");i.className="folder",i.textContent=t,l.appendChild(i);const s=document.createElement("ul");s.className="file-list",c.map(((e,t)=>({...e,originalIndex:r.indexOf(e)}))).reverse().forEach((e=>{const n=document.createElement("li");e.savedAt===o&&n.classList.add("latest-file");const r=document.createElement("span");let c,l,i;r.textContent=e.filename;const a=e=>{if(!l)return;const t=e.clientX,n=e.clientY,o=document.documentElement.scrollLeft,r=document.documentElement.scrollTop,c=document.documentElement.clientWidth,i=document.documentElement.clientHeight,s=l.getBoundingClientRect();let a=t+o+15,d=n+r+10;t+15+s.width>c-10&&(a=t+o-s.width-15),a-o<10&&(a=10+o),n+10+s.height>i-10&&(d=n+r-s.height-10),d-r<10&&(d=10+r),l.style.left=`${a}px`,l.style.top=`${d}px`};r.addEventListener("mouseenter",(t=>{clearTimeout(i),l||(clearTimeout(c),document.querySelectorAll(".file-preview-tooltip").forEach((e=>e.remove())),r.removeEventListener("mousemove",a),c=setTimeout((()=>{l=document.createElement("div"),l.className="file-preview-tooltip";const n=document.createElement("pre"),o=e.content.length>300?e.content.substring(0,300)+"...":e.content;n.textContent=o,l.appendChild(n),document.body.appendChild(l),l.addEventListener("mouseenter",(()=>{clearTimeout(i)})),l.addEventListener("mouseleave",(()=>{i=setTimeout((()=>{l&&(l.remove(),l=null,r.removeEventListener("mousemove",a))}),200)}));const c=t.clientX,s=t.clientY,d=document.documentElement.scrollLeft,m=document.documentElement.scrollTop,u=document.documentElement.clientWidth,p=document.documentElement.clientHeight,h=l.getBoundingClientRect();let g=c+d+15,E=s+m+10;c+15+h.width>u-10&&(g=c+d-h.width-15),g-d<10&&(g=10+d),s+10+h.height>p-10&&(E=s+m-h.height-10),E-m<10&&(E=10+m),l.style.left=`${g}px`,l.style.top=`${E}px`,r.addEventListener("mousemove",a)}),500))})),r.addEventListener("mouseleave",(()=>{clearTimeout(c),i=setTimeout((()=>{l&&(l.remove(),l=null,r.removeEventListener("mousemove",a))}),200)})),n.appendChild(r);const d=document.createElement("button");d.textContent="Open",d.className="open-button file-action-button",d.title="Open file content in new tab",d.onclick=t=>{t.stopPropagation();const n=new Blob([e.content],{type:e.filename.endsWith(".md")?"text/markdown;charset=utf-8":"text/html;charset=utf-8"}),o=URL.createObjectURL(n);window.open(o),setTimeout((()=>URL.revokeObjectURL(o)),100)},n.appendChild(d);const m=document.createElement("button");m.textContent="Copy",m.className="copy-button file-action-button",m.title="Copy file content",m.onclick=t=>{t.stopPropagation(),navigator.clipboard.writeText(e.content).then((()=>{console.log("Content copied successfully."),m.textContent="Copied!",setTimeout((()=>{m.textContent="Copy"}),1500)})).catch((e=>{console.error("Error copying file content:",e),alert("Failed to copy content."),m.textContent="Error",setTimeout((()=>{m.textContent="Copy"}),1500)}))},n.appendChild(m);const p=document.createElement("button");p.textContent="Delete",p.className="delete-button file-action-button",p.onclick=()=>{u(t,e.originalIndex)},n.appendChild(p),s.appendChild(n)})),l.appendChild(s)}}))}function u(e,t){console.log(`Requesting delete for date: ${e}, originalIndex: ${t}`),chrome.runtime.sendMessage({action:"deleteDownload",date:e,originalIndex:t},(e=>{chrome.runtime.lastError?(console.error("Error sending delete message:",chrome.runtime.lastError.message),alert("Error communicating with background script for deletion.")):e&&e.success?(console.log("Deletion processed by background script."),m(r.value.toLowerCase())):(console.error("Background script reported error during deletion:",e?.error),alert(`Failed to delete file: ${e?.error||"Unknown error"}`),m(r.value.toLowerCase()))}))}fetch(chrome.runtime.getURL("README.md")).then((e=>{if(!e.ok)throw new Error("Failed to fetch README.md");return e.text()})).then((e=>{const t=e.split("---");if(t.length<3)return console.error("README.md format invalid, missing sections"),void(a.innerHTML="Error: Unable to load instructions.");const n=d?t[2]?.trim():t[1]?.trim();if(!n)return console.error("Selected README.md section is empty"),void(a.innerHTML="Error: Instructions content not found.");a.innerHTML=n.replace(/## /g,"<strong>").replace(/\n/g,"<br>").replace(/-\s/g,"<li>").replace(/\*\//g,"</strong>")})).catch((e=>{console.error("Failed to load README.md:",e),a.innerHTML="Error: Unable to load instructions."})),n.addEventListener("click",(()=>{const n=e.value.trim();if(n){const r=t.value.trim();chrome.runtime.sendMessage({action:"processMarkdown",markdown:n,fileType:o.value,customFilename:r||void 0}),e.value="",t.value="",c.classList.add("show"),setTimeout((()=>{c.classList.remove("show")}),2500)}else alert("Please enter some Markdown content!")})),r.addEventListener("input",(()=>{m(r.value.toLowerCase())})),s.addEventListener("click",(()=>{chrome.windows.create({url:"popup.html?detached=true",type:"popup",width:450,height:600}),window.close()})),"true"===new URLSearchParams(window.location.search).get("detached")&&s&&(s.style.display="none"),i.addEventListener("click",(e=>{e.stopPropagation(),a.classList.toggle("show")})),document.addEventListener("click",(e=>{!a.classList.contains("show")||a.contains(e.target)||i.contains(e.target)||a.classList.remove("show")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&a.classList.contains("show")&&a.classList.remove("show")})),m()}));